@page "/work"
@using CvWebsite.Core.Models
@using CvWebsite.Core.Services
@inject ICvDataService Cv
@inject ILanguageService Lang
@implements IDisposable

@if (Data is null)
{
    <p>Loading…</p>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">@Data.Nav.Work</h1>
        <LanguageToggle />
    </div>

    @if (Data.Work is null || Data.Work.Count == 0)
    {
        <p class="text-muted">No work history yet.</p>
    }
    else
    {
        <div class="accordion shadow-sm" id="workAcc">
            @{
                var i = 0;
                foreach (var w in Data.Work)
                {
                    var headingId = $"h{i}";
                    var collapseId = $"c{i}";

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="@headingId">
                            <button class="accordion-button @(i == 0 ? "" : "collapsed")"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@collapseId">
                                <div>
                                    <div class="fw-semibold">@w.Role</div>
                                    <div class="text-muted small">@w.Company • @w.Period</div>
                                </div>
                            </button>
                        </h2>

                        <div id="@collapseId"
                             class="accordion-collapse collapse @(i == 0 ? "show" : "")"
                             data-bs-parent="#workAcc">
                            <div class="accordion-body">
                                @w.Description
                            </div>
                        </div>
                    </div>

                    i++;
                }
            }
        </div>
    }
}

@code {
    private CvData? Data;

    protected override async Task OnInitializedAsync()
    {
        Lang.Changed += OnLangChanged;
        await LoadAsync();
    }

    private async void OnLangChanged()
    {
        await LoadAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadAsync()
        => Data = await Cv.GetAsync(Lang.Current);

    public void Dispose()
        => Lang.Changed -= OnLangChanged;
}